{% extends 'parent/base.html' %}
{% load static %}

{% block title %}Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¬Ø¯ÛŒØ¯{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/parent/forms.css' %}">
    {{ form.media }}
{% endblock %}

{% block body %}
    <section class="form-section fade-up">
        <div class="form-wrapper container">
            <h1 class="form-title">Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¬Ø¯ÛŒØ¯</h1>

            <form method="post" enctype="multipart/form-data" class="form-container">
                {% csrf_token %}
                <fieldset>
                    <legend>Ø§Ø·Ù„Ø§Ø¹Ø§Øª</legend>
                    {{ form.as_div }}
                </fieldset>
                <fieldset>
                    <legend>Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</legend>

                    <!-- Ø§ÙØ²ÙˆØ¯Ù† ØªÚ¯ Ø¬Ø¯ÛŒØ¯ -->
                    <div class="tag-selector">
                        <input id="new_tag_input" type="text"
                               placeholder="Ù†Ø§Ù… Ø¨Ø±Ú†Ø³Ø¨ Ø¬Ø¯ÛŒØ¯"
                               class="input-outline">
                        <button type="button" id="add_new_tag_btn" class="btn btn-primary">
                            Ø§ÙØ²ÙˆØ¯Ù†
                        </button>
                    </div>

                    <!-- Ø§Ù†ØªØ®Ø§Ø¨ ØªÚ¯ Ù…ÙˆØ¬ÙˆØ¯ -->
                    <div class="tag-selector">
                        <select id="existing_tag_select" class="input-outline">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                            {% for tag in existing_tags %}
                                <option value="{{ tag.id }}">{{ tag.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" id="add_existing_tag_btn" class="btn btn-primary">
                            Ø§ÙØ²ÙˆØ¯Ù†
                        </button>
                    </div>

                    <!-- Ù†Ù…Ø§ÛŒØ´ ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ -->
                    <div id="selected_tags_box" class="tag-box"></div>
                </fieldset>

                <input type="hidden" name="selected_tags" id="selected_tags_input">

                <!-- ğŸ¯ Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª -->
                <div class="form-actions">
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡</button>
                    </div>
                </div>
            </form>
        </div>
    </section>
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/upload-file.js' %}"></script>
    <script>
        let selectedTags = [];

        function renderTags() {
            const box = document.getElementById("selected_tags_box");
            box.innerHTML = "";

            selectedTags.forEach(tag => {
                const pill = document.createElement("div");
                pill.className = "tag-pill";
                pill.innerHTML = `${tag.name} <button data-id="${tag.id}">Ã—</button>`;
                box.appendChild(pill);
            });

            document.getElementById("selected_tags_input").value =
                selectedTags.map(t => t.id).join(",");
        }

        document.addEventListener("click", function (e) {
            if (e.target.tagName === "BUTTON" && e.target.dataset.id) {
                const id = parseInt(e.target.dataset.id);
                selectedTags = selectedTags.filter(t => t.id !== id);
                renderTags();
            }
        });

        document.getElementById("add_existing_tag_btn").onclick = function () {
            const select = document.getElementById("existing_tag_select");
            const id = parseInt(select.value);

            if (!id) return;

            const name = select.options[select.selectedIndex].text;

            if (!selectedTags.find(t => t.id === id)) {
                selectedTags.push({id: id, name: name});
                renderTags();
            }
        };

        document.getElementById("add_new_tag_btn").onclick = function () {
            const input = document.getElementById("new_tag_input");
            const name = input.value.trim();
            if (!name) return;

            fetch("{% url 'notification:create_tag_ajax' %}", {
                method: "POST",
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                body: new URLSearchParams({"name": name})
            })
                .then(r => r.json())
                .then(data => {
                    selectedTags.push({id: data.id, name: data.name});
                    renderTags();
                    input.value = "";
                });
        };
    </script>
{% endblock %}