{% extends 'parent/base.html' %}
{% load static %}

{% block title %}ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'accounts/css/edit_profile.css' %}">
  <!-- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ -->
  {{ form.media }}
{% endblock %}

{% block body %}
<div class="edit-profile container">
  <h1>ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h1>

  <form method="post" enctype="multipart/form-data" class="edit-form">
    {% csrf_token %}

    <!-- ğŸ”¹ Ø¨Ø®Ø´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
    <div class="avatar-row">
      <div class="current-avatar">
        {% if user.photo %}
          <img id="avatar-preview" src="{{ user.photo.url }}" alt="{{ user.username }}">
          <button type="button" id="remove-photo-btn">Ø­Ø°Ù Ø¹Ú©Ø³</button>
        {% else %}
          <img id="avatar-preview" src="{% static 'accounts/img/default.png' %}" alt="Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±">
        {% endif %}
      </div>

      <div class="photo-input">
        <label for="{{ form.photo.id_for_label }}">ØªØºÛŒÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</label>
        {{ form.photo }}
      </div>
    </div>

    <!-- ğŸ”¹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± -->
    <div class="form-row">
      <label for="{{ form.first_name.id_for_label }}">Ù†Ø§Ù…</label>
      {{ form.first_name }}
    </div>

    <div class="form-row">
      <label for="{{ form.last_name.id_for_label }}">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
      {{ form.last_name }}
    </div>

    <div class="form-row">
      <label for="{{ form.email.id_for_label }}">Ø§ÛŒÙ…ÛŒÙ„</label>
      {{ form.email }}
    </div>

    <div class="form-row">
      <label for="{{ form.date_of_birth.id_for_label }}">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ø´Ù…Ø³ÛŒ)</label>
      {{ form.date_of_birth }}
    </div>

    <div class="form-row">
      <label for="{{ form.bio.id_for_label }}">Ø¨ÛŒÙˆ</label>
      {{ form.bio }}
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
      <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('{{ form.photo.id_for_label }}');
    const previewImg = document.getElementById('avatar-preview');
    const removeBtn = document.getElementById('remove-photo-btn');

    // âœ… Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡ Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            previewImg.src = event.target.result;
            previewImg.alt = "Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯";
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // âŒ Ø­Ø°Ù Ø¹Ú©Ø³ ÙØ¹Ù„ÛŒ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¨Ø§ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        if (fileInput) fileInput.value = '';
        previewImg.src = "{% static 'default.png' %}";
        previewImg.alt = "Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±";

        let removeInput = document.getElementById('remove_photo_field');
        if (!removeInput) {
          removeInput = document.createElement('input');
          removeInput.type = 'hidden';
          removeInput.name = 'remove_photo';
          removeInput.id = 'remove_photo_field';
          removeInput.value = '1';
          document.querySelector('form.edit-form').appendChild(removeInput);
        }
      });
    }
  });
</script>
{% endblock %}